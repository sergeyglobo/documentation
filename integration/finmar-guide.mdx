---
title: "Интеграция Finmar / Vimapay Checkout"
description: "Пошаговое руководство по подключению Finmar (Vimapay) Checkout: создание операции, отображение платёжной страницы, обработка callback и подтверждение платежей."
sidebarTitle: "Гайд по интеграции"
---

# Интеграция Finmar / Vimapay Checkout

Документ объясняет, как быстро подключить платёжный Checkout через Finmar (Vimapay): от получения доступа до подтверждения успешных оплат. Все примеры приведены на русском и ориентированы на возможности текущего API.

<Note>
Если что-то непонятно — напишите менеджеру интеграции в Telegram: https://t.me/integrationVimapay
</Note>

## Что вы получите

- Хостед-платёжную страницу (HPP) с поддержкой карт, open banking, Blik и кошельков.
- Унифицированные статусы операций и callback-уведомления в реальном времени.
- Рекомендации по безопасной работе: идемпотентность, проверка статусов, резервный опрос.

<Steps>
<Step title="Подготовьте доступ и окружение">
  Получите у менеджера следующие данные:

  - `payment_profile` для нужной среды (`sandbox` или боевой профиль).
  - Пару Basic Auth (логин/пароль), из которой формируется `Authorization: Basic ...`.
  - Базовые URL:

  <Tabs>
  <Tab title="Sandbox">
  https://sandbox.finmar.tech
  </Tab>
  <Tab title="Production">
  https://finmar.tech
  </Tab>
  </Tabs>

  <Warning>
  Не храните креденшелы в клиентском коде. Все обращения к Finmar API делайте с вашего сервера.
  </Warning>
</Step>

<Step title="Создайте платёжную операцию">
  Отправьте запрос на создание операции. Укажите способ оплаты, сумму, пользователя и ссылки для редиректов и callback.

  <RequestExample>
  ```bash cURL
  curl --location 'https://sandbox.finmar.tech/prepare2/api/v3/checkout' \
    --header 'Content-Type: application/json' \
    --header "Authorization: Basic $FINMAR_BASIC" \
    --data '{
      "payment_profile": "sandbox",
      "method": "card",
      "client_operation_id": "order-12345",
      "user": { "user_id": "user-789" },
      "amount": { "amount": "150.00", "currency": "EUR" },
      "url_callback": "https://merchant.com/api/finmar/callback",
      "url_redirect_success": "https://merchant.com/pay/success",
      "url_redirect_fail": "https://merchant.com/pay/fail"
    }'
  ```
  </RequestExample>

  <ResponseExample>
  ```json Success
  {
    "success": true,
    "result": {
      "url": "https://crypto.cheipho.com/payment-front/2c2b55bb-fc23-4b13-9f51-2b6f7a28016b",
      "reference_id": "72a92c72-1baf-4854-a7c2-b35a404d6ff1",
      "launch_type": "new_window",
      "kyc_status": "none",
      "user_stats": "not_present"
    },
    "trace_id": "442556cc81dd4f53872c09c6b910ca28"
  }
  ```
  </ResponseExample>

  <Tip>
  Используйте уникальный `client_operation_id` на каждую попытку. Сохраняйте `reference_id` — он нужен для подтверждения и сверки статуса.
  </Tip>
</Step>

<Step title="Откройте платёжную страницу пользователю">
  В ответе приходит `result.launch_type` с рекомендацией, как показать страницу оплаты.

  ```javascript
  function openCheckout(result) {
    switch (result.launch_type) {
      case 'redirect':
        window.location.href = result.url;
        break;
      case 'iframe':
        // Покажите iframe в вашем layout
        const iframe = document.createElement('iframe');
        iframe.src = result.url;
        iframe.width = '100%';
        iframe.height = '800';
        iframe.frameBorder = '0';
        document.getElementById('checkout-container').appendChild(iframe);
        break;
      case 'new_window':
      default:
        window.open(result.url, '_blank');
    }
  }
  ```

  <Info>
  После завершения оплаты пользователь вернётся на `url_redirect_success` или `url_redirect_fail`. Используйте эти страницы, чтобы показать итог и инициировать проверку статуса.
  </Info>
</Step>

<Step title="Принимайте callback-уведомления">
  Finmar шлёт POST на `url_callback` при изменении статуса операции.

  ```javascript
  import express from 'express';

  const app = express();
  app.use(express.json());

  app.post('/api/finmar/callback', async (req, res) => {
    const notification = req.body;

    // 1) Идемпотентность: не обрабатывайте одну и ту же операцию дважды
    const exists = await db.operations.findOne({ reference_id: notification.reference_id });
    if (exists?.processed) {
      return res.status(200).json({ received: true });
    }

    // 2) Бизнес-логика
    if (notification.status === 'success') {
      await creditBalance(notification.user.user_id, notification.amount);
    }

    // 3) Сохраняем факт обработки
    await db.operations.updateOne(
      { reference_id: notification.reference_id },
      { $set: { processed: true, status: notification.status } },
      { upsert: true }
    );

    // 4) Отвечаем 200 OK за <=5 секунд
    res.status(200).json({ received: true });
  });
  ```

  <Warning>
  Всегда отвечайте **200 OK** за 5 секунд. При ошибке Finmar повторит отправку уведомления.
  </Warning>
</Step>

<Step title="Подтвердите успешную оплату">
  После зачисления средств клиенту подтвердите операцию в Finmar. Это обязательный шаг, чтобы закрыть цикл.

  <CodeGroup>
  ```bash По reference_id
  curl --location 'https://sandbox.finmar.tech/collector/api/v3/client_confirm_payment_by_reference_id' \
    --header 'Content-Type: application/json' \
    --header "Authorization: Basic $FINMAR_BASIC" \
    --data '{ "reference_id": "72a92c72-1baf-4854-a7c2-b35a404d6ff1" }'
  ```

  ```bash По client_operation_id
  curl --location 'https://sandbox.finmar.tech/collector/api/v3/client_confirm_payment_by_client_operation_id' \
    --header 'Content-Type: application/json' \
    --header "Authorization: Basic $FINMAR_BASIC" \
    --data '{ "client_operation_id": "order-12345" }'
  ```
  </CodeGroup>
</Step>

<Step title="Запускайте резервный опрос">
  Если callback пропущен, запрашивайте неподтверждённые успехи и закрывайте их.

  ```javascript
  import fetch from 'node-fetch';

  async function sweepUnconfirmed() {
    const resp = await fetch(
      'https://sandbox.finmar.tech/collector/api/v3/client_unconfirmed_success_payments',
      { headers: { Authorization: `Basic ${process.env.FINMAR_BASIC}` } }
    );
    const operations = await resp.json();

    for (const op of operations) {
      await creditBalance(op.user_id, {
        amount: op.complete_amount,
        currency: op.complete_currency
      });

      await fetch('https://sandbox.finmar.tech/collector/api/v3/client_confirm_payment_by_reference_id', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Basic ${process.env.FINMAR_BASIC}`
        },
        body: JSON.stringify({ reference_id: op.reference_id })
      });
    }
  }

  // Запуск каждые 5 минут
  setInterval(sweepUnconfirmed, 5 * 60 * 1000);
  ```

  <Check>
  После подтверждения каждая успешная операция будет считаться закрытой в Finmar.
  </Check>
</Step>
</Steps>

## Частые вопросы

<AccordionGroup>
<Accordion title="Как тестировать локально?">
- Используйте `sandbox` профиль и туннели (ngrok, Cloudflare Tunnel), чтобы Finmar мог отправлять callback на ваш локальный сервер.
</Accordion>

<Accordion title="Что возвращать фронтенду?">
- Только безопасные данные: `result.url`, `reference_id`, статусы. Никогда не возвращайте креденшелы или чувствительные поля запроса.
</Accordion>

<Accordion title="Какие статусы могут прийти?">
- `pending` — операция создаётся или ожидает завершения.
- `success` — оплата прошла; зачислите средства и подтвердите.
- `fail` / `canceled` — неуспех, не зачисляйте средства.
</Accordion>

<Accordion title="Как обрабатывать повторные callback?">
- Делайте операции идемпотентными: проверяйте `reference_id` и флаг обработанности перед зачислением.
</Accordion>
</AccordionGroup>

