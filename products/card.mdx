---
title: "Банковские карты"
description: "Приём оплаты банковскими картами"
icon: "credit-card"
mode: "frame"
---
import TestCards from '/snippets/test-cards.mdx';

## Общая схема работы

```mermaid
sequenceDiagram

autonumber

    participant site as Ваш сайт #lightGreen

    participant server as Ваш сервер

    participant finmart as API Finmart

    site->>server: Пользователь нажимает кнопку метода

    server->>finmart: Запрос на получение ссылки на платёжную страницу

    finmart-->>server: Ссылка на платёжную страницу

    server-->>site: Показ пользователю платёжной страницы

    note over site:  Пользователь проходит платёжный флоу

    finmart-->>site: Перенаправление пользователя на `url_redirect_success` или `url_redirect_fail`

    finmart-->>server: Обратное уведомление

    server-->>site: Обработка операции (зачисление средств пользователю)

    server->>finmart: Подтверждение операции    

    loop Запрос успешных неподтверждённых операций

            server->>finmart: GET /collector/api/v3/client_unconfirmed_success_payments

            finmart-->>server: array()

        note over server: Обработка операций

        server -->> site: Обработка операции

        server -->>site: Обновление баланса

        server->>finmart: Подтверждение операции        

    end
```

<Steps>
  <Step title="Инициирование оплаты пользователем">
    Пользователь нажимает кнопку оплаты на вашем сайте, инициируя процесс взаимодействия с вашим сервером.
  </Step>
  <Step title="Запрос ссылки на платёжную страницу">
    Ваш сервер отправляет запрос к API Finmart для получения уникальной ссылки на платёжную страницу.
  </Step>
  <Step title="Получение ссылки на платёжную страницу">
    API Finmart взаимодействует с платёжным провайдером и передаёт вашему серверу сгенерированную ссылку на платёжную страницу.
  </Step>
  <Step title="Показ пользователю платёжной страницы">
    Ваш сервер перенаправляет пользователя на полученную платёжную страницу, где он проходит процесс оплаты.
  </Step>
  <Step title="Перенаправление пользователя на `url_redirect_success` или `url_redirect_fail`">
    После завершения платежа платёжный провайдер перенаправляет пользователя обратно на ваш сайт по заранее определённым URL-адресам (`url_success` или `url_result`).
  </Step>
  <Step title="Обратное уведомление">
    API Finmart отправляет уведомление на ваш сервер о статусе операции через указанный `url_callback`.
  </Step>
  <Step title="Обработка операции (зачисление средств пользователю)">
    Ваш сервер обрабатывает полученное уведомление, проверяет подпись, зачисляет средства пользователю и подтверждает получение уведомления, отправляя запрос `POST /api/operation/set_ack_id` в Finmart.
  </Step>
  <Step title="Подтверждение операции">
    После успешной обработки операции (зачисления средств пользователю) ваш сервер подтверждает обработку операции, отправляя запрос на подтверждение в Finmart API.
  </Step>
  <Step title="Обработка новых успешных операций (цикл)">
    Ваш сервер периодически запрашивает у Finmart список неподтверждённых успешных операций (`GET /collector/api/v3/client_unconfirmed_success_payments`). После получения и обработки этих операций ваш сервер подтверждает обработку каждой операции, обновляет баланс пользователя на вашем сайте и снова устанавливает `operation_ack_id` для предотвращения дублирования. Этот цикл повторяется для обработки всех новых успешных операций.
  </Step>
</Steps>
 
 <TestCards />

 <Note>
  Перед началом интеграции запросите имя пользователя и пароль для тестового окружения в чате интеграции
</Note>

<CardGroup cols={1}>
  <Card title="Документация по интеграции" icon="book" horizontal href="/api-reference/introduction">
    Подробная информация о создании операций, обработке уведомлений и подтверждении платежей
  </Card>  
</CardGroup>


 